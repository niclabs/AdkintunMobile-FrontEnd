<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="viewport" content="width=device-width, initial-scale=1">

  <title>Adkintun - Reportes</title>

  <link rel="stylesheet" href="//maxcdn.bootstrapcdn.com/font-awesome/4.2.0/css/font-awesome.min.css">
  <link rel="stylesheet" href="http://maxcdn.bootstrapcdn.com/bootstrap/3.3.6/css/bootstrap.min.css">
  <link rel="stylesheet" href="{{ url_for('static', filename='css/bootstrap-datetimepicker.min.css') }}">
  <link rel="stylesheet" href="{{ url_for('static', filename='css/c3.min.css') }}">
  <script src="https://ajax.googleapis.com/ajax/libs/jquery/1.12.4/jquery.min.js"></script>
  <script src="{{ url_for('static', filename='js/moment.js') }}"></script>
  <script src="http://maxcdn.bootstrapcdn.com/bootstrap/3.3.6/js/bootstrap.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/bootstrap-datetimepicker/4.14.30/js/bootstrap-datetimepicker.min.js"></script>
  <script src="{{ url_for('static', filename='js/carriers.js') }}"></script>
  <script src="{{ url_for('static', filename='js/d3.v3.js') }}"></script>
  <script src="{{ url_for('static', filename='js/c3.min.js') }}"></script>
</head>

<script type=text/javascript>
    $SCRIPT_ROOT = {{ request.script_root|tojson|safe }};
</script>

<body>
<ul class="nav nav-pills">
  <li role="presentation"><a href="{{url_for('index')}}">Mapa de antenas</a></li>
  <li role="presentation"><a href="{{url_for('charts')}}">Gráficos</a></li>
  <li role="presentation" class="active"><a href="#">Reportes totales</a></li>
</ul>
<div class="container">
  <div class="form-group">
    <label for="datetimepicker1">Seleccione fecha</label>
    <div class='input-group date' id='datetimepicker1'>
      <input type='text' class="form-control"/>
      <span class="input-group-addon">
              <span class="glyphicon glyphicon-calendar"></span>
      </span>
    </div>
  </div>
</div>
<div class="container" id="reports" style="display: none;">
  <div class="panel panel-default">
      <!-- Default panel contents -->
      <div class="panel-heading"><h4>Dispositivos</h4></div>
      <div class="panel-body">
          <div class="row">
              <div>
                  <div class="col-xs-6 col-md-4 col-md-offset-4">
                    <div id="devicesChart"></div>
                  </div>
              </div>
          </div>
          <div class="row">
              <div class="col-md-6 col-md-offset-3">
                  <div class="panel panel-default" id="tabla1">
                      <table class="table table-bordered text-center" id="devices">
                          <thead class="thead-default">
                              <tr>
                              </tr>
                          </thead>
                      </table>
                  </div>
              </div>
          </div>
          <div class="alert alert-danger" id="error1">
              <span class="glyphicon glyphicon-info-sign"></span>
              <strong>No hay información disponible para esta fecha</strong>
          </div>
      </div>
  </div>
  <div class="panel panel-default">
    <!-- Default panel contents -->
      <div class="panel-heading"><h4>Mediciones</h4></div>
      <div class="panel-body">
          <div class="col-xs-6 col-md-10 col-md-offset-1">
              <div id="gsmChart"></div>
          </div>-
          <div class="row">
              <div class="col-md-6 col-md-offset-3">
                  <div class="panel panel-default" id="tabla2">
                      <table class="table table-bordered text-center" id="gsm">
                          <thead class="thead-default">
                              <tr>
                              </tr>
                          </thead>
                      </table>
                  </div>
              </div>
          </div>
          <div class="alert alert-danger" id="error2">
              <span class="glyphicon glyphicon-info-sign"></span>
              <strong>No hay información disponible para esta fecha</strong>
          </div>
      </div>
  </div>
  <div class="panel panel-default">
    <!-- Default panel contents -->
      <div class="panel-heading"><h4>SIMS</h4></div>
      <div class="panel-body">
          <div class="row">
              <div class="col-xs-6 col-md-4 col-md-offset-4">
                  <div id="simsChart"></div>
              </div>
              <div class="row">
                  <div class="col-md-6 col-md-offset-3">
                      <div class="panel panel-default" id="tabla3">
                          <table class="table table-bordered text-center" id="sims">
                              <thead class="thead-default">
                                  <tr>
                                  </tr>
                              </thead>
                          </table>
                      </div>
                  </div>
              </div>
          </div>
          <div class="alert alert-danger" id="error3">
              <span class="glyphicon glyphicon-info-sign"></span>
              <strong>No hay información disponible para esta fecha</strong>
          </div>
      </div>
  </div>
</div>

<div class="container" id="signal" style="display: none;">
	<div class="panel panel-default">
		<!-- Default panel contents -->
        <div class="panel-heading">
            <h4>Intensidad de señal por carrier</h4>
            <div id="medHeading">
                <h4> (Mediana) </h4>
            </div>
        </div>
        <div class="panel-body">
            <div class="row">
                <div class="col-xs-6 col-md-10 col-md-offset-1">
                    <div id="signalChart"></div>
                    <div id="signalLegend"></div>
                </div>
            </div>
            <div id="loading1"><h4><i class="fa fa-spinner fa-spin"></i> Loading...</h4></div>
            <div class="alert alert-danger" id="error4">
                <span class="glyphicon glyphicon-info-sign"></span>
                <strong>No hay información disponible para esta fecha</strong>
            </div>
        </div>
	</div>
</div>

<div class="container" id="network" style="display: none;">
    <div class="panel panel-default">
        <!-- Default panel contents -->
        <div class="panel-heading">
            <h4>Eventos registrados por carrier</h4>
            <div id="logHeading">
                <h4> (Escala logarítmica) </h4>
            </div>
        </div>
        <div class="panel-body">
            <div class="row">
                <div class="col-xs-6 col-md-10 col-md-offset-1">
                    <div id="networkChart"></div>
                </div>
            </div>
            <div id="loading2"><h4><i class="fa fa-spinner fa-spin"></i> Loading...</h4></div>
            <div class="alert alert-danger" id="error5">
                <span class="glyphicon glyphicon-info-sign"></span>
                <strong>No hay información disponible para esta fecha</strong>
            </div>
        </div>
    </div>
</div>

</body>
<script type="text/javascript">

    //SignalChart Legend
    $("#signal").show();
    var dataLegend = ["Baja", "Media", "Alta"];
    var color = ['red', '#F2AC13', 'green'];

    var legendRectSize = 12;
    var legendSpacing = 22;

    var svg = d3.selectAll('#signalLegend').append('svg')
        .attr("width", "100%")
        .attr("height",$("#signalChart").width()/20);
    var legend = svg.selectAll('.legend')
        .data(dataLegend)
        .enter()
        .append('g')
        .attr('class', 'legend')
        .attr('transform', function(d, i) {
            var height = legendRectSize + legendSpacing;
            var offset =  height * dataLegend.length / 2;
            var vert = 2 * legendRectSize;
            var horz = i * 2 * height - offset + $("#signalLegend").width()/2;
            return 'translate(' + horz + ',' + vert + ')';
        });
    legend.append('rect')
        .attr('width', legendRectSize)
        .attr('height', legendRectSize)
        .style('fill', function (d, i) { return color[i]; })
        .style('fill-opacity', 0.26)
        .style('stroke', function (d, i) { return color[i]; })
        .style('stroke-opacity', 0.5);

    legend.append('text')
        .attr('x', legendRectSize + legendSpacing/4)
        .attr('y', legendRectSize - 1)
        .text(function(d) { return d; })
        .attr('font-size', '14px');

    $("#signal").hide();

     var localeFormatter = d3.locale({
                        "decimal": ",",
                        "thousands": ".",
                        "grouping": [3],
                        "currency": ["", "€"],
                        "dateTime": "%a, %e %b %Y, %X",
                        "date": "%d.%m.%Y",
                        "time": "%H:%M:%S",
                        "periods": ["", ""],
                        "days": ["Sonntag", "Montag", "Dienstag", "Mittwoch", "Donnerstag", "Freitag", "Samstag"],
                        "shortDays": ["So", "Mo", "Di", "Mi", "Do", "Fr", "Sa"],
                        "months": ["Januar", "Februar", "März", "April", "Mai", "Juni", "Juli", "August", "September", "Oktober", "November", "Dezember"],
                        "shortMonths": ["Jan", "Feb", "Mär", "Apr", "Mai", "Jun", "Jul", "Aug", "Sep", "Okt", "Nov", "Dec"]
                    });
     var numberFormat = localeFormatter.numberFormat(",.f");

    //datetimepicker format
    $(function () {
        $('#datetimepicker1').datetimepicker({
            format: 'MM-YYYY',
            useCurrent: false
        });
    });

    //datetimepicker event
    $("#datetimepicker1").on("dp.change", function (e) {
        var date = $("#datetimepicker1").data("DateTimePicker").date().toDate();
        var year = date.getFullYear();
        var month = date.getMonth() + 1;
        var url = $SCRIPT_ROOT + "/getReport"

        $('#devicesChart').hide();
        $('#gsmChart').hide();
        $('#simsChart').hide();
        $('#signalChart').hide();
        $('#networkChart').hide();
        $('#logHeading').hide();
        $('#medHeading').hide();
        $('#error1').hide();
        $('#error2').hide();
        $('#error3').hide();
        $('#error4').hide();
        $('#error5').hide();
        $('#signalLegend').hide();
        $('#loading1').show();
        $('#loading2').show();

        var jqxhr = $.getJSON(url, {
            year: year,
            month: month
        }, function () {
        })
            .done(function (data) {
                console.log(data);
                var add, mnc;
                $("#reports").show();
                $("#tabla1").show();

                //populate devices
               add = "";
               add += "<tr><td class='active'>Total: &emsp;"+ numberFormat(data.total_devices) + "</td></tr>"
               $("#devices thead").html(add);

                if (!(Object.keys(data.total_device_carrier).length === 0)) {
                    $('#devicesChart').show();
                    var chart = c3.generate({
                        bindto: '#devicesChart',
                        data: {
                            json: data.total_device_carrier,

                            type: 'donut',
                            colors: {
                                'Claro': '#d9051a',
                                'Entel PCS Telecomunicaciones S.A.': '#1a74cc',
                                'Movistar': '#67b71e',
                                'VTR Móvil': '#f77a00',
                                'Virgin Mobile': '#ef1f6e',
                                'WOM': '#6b017d'
                            },
                            onclick: function (d, i) {
                                console.log("onclick", d, i);
                            },
                            onmouseover: function (d, i) {
                                console.log("onmouseover", d, i);
                            },
                            onmouseout: function (d, i) {
                                console.log("onmouseout", d, i);
                            }
                        },
                        legend: {
                            item: {
                                onclick: function() {}
                            }
                        },
                        donut: {
                            title: "Dispositivos"
                        },
                        padding: {
                            top: 20
                        },
                        tooltip: {
                            format: true,
                        }
                    });
                } else {
                    $("#tabla1").hide();
                    $("#error1").show();
                }

                //populate gsm

                add = "";
                add += "<tr><td class='active'>Total: &emsp;"+ numberFormat(data.total_gsm) + "</td></tr>"
                $("#gsm thead").html(add);

                if (!(Object.keys(data.total_gsm_carrier).length === 0)) {
                    $('#gsmChart').show();
                    $("#tabla2").show();


                    var xaxis = $.map(data.total_gsm_carrier, function(value, key) { return key; });
                    var yaxis = $.map(data.total_gsm_carrier, function(value, key) { return value; });

                    var chart = c3.generate({
                        bindto: '#gsmChart',
                        data: {
                            x: 'x',
                            columns: [
                                    ['x'].concat(xaxis),
                                    ['Mediciones'].concat(yaxis),
                            ],
                            type: 'bar',
                            labels: {
                                format: numberFormat,
                                color: {
                                    pattern: ['black']
                                },
                            }
                        },
                        tooltip: {
                            format: {
                                name: function (name, ratio, id, index) { return name; },
                                value: function (value, ratio, id) {return numberFormat(value);}
                            }
                        },
                        legend: {
                            show: false,
                        },
                        padding: {
                            top: 20
                        },
                        axis: {
                            rotated: true,
                            x: {
                                type: 'category',
                            },
                            y: {
                                tick: {
                                    format: numberFormat
                                }
                            }
                        },
                        color: {
                            pattern: ['#2c74b9']
                        },
                    });

                } else {
                    $("#tabla2").hide();
                    $("#error2").show();
                }

                //populate sims
                add = "";
                add += "<tr><td class='active'>Total: &emsp;"+ numberFormat(data.total_sims) + "</td></tr>"
                $("#sims thead").html(add);

                if (!(Object.keys(data.total_sims_carrier).length === 0)) {
                    $('#simsChart').show();
                    $("#tabla3").show();

                    var chart = c3.generate({
                        bindto: '#simsChart',
                        data: {
                            json: data.total_sims_carrier,

                            type: 'donut',
                            colors: {
                                'Claro': '#d8051a',
                                'Entel PCS Telecomunicaciones S.A.': '#1a75cd',
                                'Movistar': '#67b61e',
                                'VTR Móvil': '#f67800',
                                'Virgin Mobile': '#ee1e6b',
                                'WOM': '#6a017b'
                            },
                            onclick: function (d, i) {
                                console.log("onclick", d, i);
                            },
                            onmouseover: function (d, i) {
                                console.log("onmouseover", d, i);
                            },
                            onmouseout: function (d, i) {
                                console.log("onmouseout", d, i);
                            }
                        },
                        padding: {
                            top: 20
                        },
                        donut: {
                            title: "SIMS"
                        },
                        legend: {
                            item: {
                                onclick: function() {}
                            }
                        },
                        tooltip: {
                            format: true,
                        }
                    });
                    d3.selectAll('.c3-text').style('fill', 'black')
                                            .style('font-size', '11px');
                    d3.selectAll('.c3-axis-x text').style('font-size', '12px');
                    d3.selectAll('.c3-arcs').style('opacity', 0.84);
                } else {
                    $("#tabla3").hide();
                    $("#error3").show();
                }

            })

        // New information for signal meditions
	    var jqxhr = $.getJSON($SCRIPT_ROOT + "/getGsmSignal", {
            year: year,
            month: month
        }, function () {
        })
            .done(function (data) {
                $("#signal").show();
                $('#signalLegend').show();

                if (!(Object.keys(data).length === 0)) {
                    $('#loading1').hide();
                    $('#signalChart').show();
                    $('#medHeading').show();
                    var xaxis = $.map(data, function(value, key) { return key; });
                    var yaxis = $.map(data, function(value, key) { return value; });

                    var chart = c3.generate({
                        bindto: '#signalChart',
                        data: {
                            x: 'x',
                            columns: [
                                    ['x'].concat(xaxis),
                                    ['Intensidad'].concat(yaxis),
                            ],
                            type: 'bar',
                            labels: {
                                    format: function (d) {
                                        return numberFormat(d3.round(30 + 10 * Math.log10(d), 2));
                                    }
                            },

                        },
                        regions: [
                            {axis: 'y', start: 5.6234132519e-23, end: 1e-13, opacity: 0.2},//-192.5 to -100 dbm
                            {axis: 'y', start: 1e-13, end: 3.1622776602e-12, opacity: 0.18},//-100 to -85 dbm
                            {axis: 'y', start: 3.1622776602e-12, end: 0.00079432823472, opacity: 0.18}//-85 to -1 dbm
                        ],
                        grid: {
                          y: {
                            lines: [
                              {value: 1e-13},
                              {value: 3.1622776602e-12}
                            ]
                          }
                        },
                        tooltip: {
                            format: {
                                name: function (name, ratio, id, index) { return name; },
                                value: function (d) {return numberFormat(d3.round(30 + 10 * Math.log10(d), 2)) + ' [dBm]';
                                }
                            }
                        },
                        legend: {
                            show: false,
                        },
                        padding: {
                            top: 20
                        },
	                    point: {
                            r: 5
	                    },
                        axis: {
                            rotated: true,
                            x: {
                                type: 'category'
                            },
                            y: {
                                label: {
                                    text: 'Intensidad de señal [dBm]',
                                    position: 'outer-center'
                                },
                                tick: {
                                   format: function (d) {
                                       if (d != 0) {return numberFormat(d3.round(30 + 10 * Math.log10(d), 2));}
                                   }
                                }
                            },
                        },
                        color: {
                            pattern: ['#2c74b9']
                        },
                    });

                    d3.selectAll('.c3-text').style('fill', 'black')
                        .style('font-size', '11px');
                    d3.selectAll('.c3-axis-x text').style('font-size', '12px');
                    d3.selectAll('.c3-axis-y-label').style('font-size', '12px')
                                                    .attr('dy', '3.2em');
                    d3.selectAll('.c3-region-0').style('fill', 'red');
                    d3.selectAll('.c3-region-1').style('fill', '#F2AC13');
                    d3.selectAll('.c3-region-2').style('fill', 'green');
                    d3.selectAll('.c3-grid line').style('stroke', '#545c6e');

                } else {
                    $('#loading1').hide();
                    $('#signalLegend').hide();
                    $("#error4").show();
                }
            })

	    // New information for ammount of signals (2G, 3G, 4G, unknown)
	    var jqxhr = $.getJSON($SCRIPT_ROOT + "/getNetwork", {
            year: year,
            month: month
        }, function () {
        })
            .done(function (data) {
                $('#loading2').hide();
                $("#network").show();

                if (!(Object.keys(data).length === 0)) {
                    $('#networkChart').show();
                    $('#logHeading').show();
                    var yaxis = [];
                    var x2G = [];
                    var x3G = [];
                    var x4G = [];
                    var xOtras = [];

                    $.each(data, function(k,v) {
                        yaxis.push(k)
                        x2G.push(v['2G'] == 0? 0 : Math.log(v['2G']) / Math.LN10)
                        x3G.push(v['3G'] == 0? 0 : Math.log(v['3G']) / Math.LN10)
                        x4G.push(v['4G'] == 0? 0 : Math.log(v['4G']) / Math.LN10)
                        xOtras.push(v['Otras']  == 0? 0 : Math.log(v['Otras']) / Math.LN10)
                    })


                    var chart = c3.generate({
                        bindto: '#networkChart',
                        data: {
                            x: 'x',
                            columns: [
                                ['x'].concat(yaxis),
                                ['2G'].concat(x2G),
                                ['3G'].concat(x3G),
                                ['4G'].concat(x4G),
                                ['Otras'].concat(xOtras)
                            ],
                            labels: false,
                            type: 'bar',
                        },
                        bar: {
                            width: 12
                        },
                        tooltip: {
                            format: {
                                name: function (name, ratio, id, index) { return name; },
                                value: function (d) {
                                    if (d == 0) {
                                        return 0;
                                    }
                                    return numberFormat(Math.pow(10,d).toFixed(0));
                                }
                            }
                        },
                        legend: {
                            //position: 'right',
                            item: {
                                onclick: function() {}
                            }
                        },
                        size: {
                            height: 480
                        },
                        padding: {
                            top: 20
                        },
                        axis: {
                            x: {
                              type: 'categorized',
                            }, rotated:true,
                             y : {
                                 show:true,
                                 tick: {
                                   format: function (d) {return numberFormat(Math.pow(10,d).toFixed(0));}
                                 }
                             }
                        },
                        color: {
                        pattern: ['#1f77b4', '#aec7e8', '#ff7f0e', '#ffbb78', '#2ca02c', '#98df8a']
                       },
                    });
                    d3.select('#networkChart')
                        .selectAll('.c3-axis-x text').style('font-size', '12px');

                } else {
                    $('#loading2').hide();
                    $('#error5').show();
                }
            })
    });

</script>
</html>
